!function(){"use strict";let e={botEnabled:!1,botApiKey:"",botContext:"",botUseInvi:!1,botModel:"gemini-2.0-flash",botWelcomeEnabled:!1,botWelcomeMsg:"",botHistoryBtnEnabled:!1,botSummaryEnabled:!1},t=new Set,n=[],o=!1;const i={START:"‚Äå",END:"Û†Å°",CHARS:["Û†Å¢","Û†Å£","Û†Å§","Û†Å•","Û†Å¶","Û†Åß","Û†Å®","Û†Å©","Û†Å™","Û†Å´","Û†Å¨","Û†Å≠","Û†ÅÆ","Û†ÅØ","Û†Å∞","Û†Å±","Û†Å≤","Û†Å≥","Û†Å¥","Û†Åµ","Û†Å∂","Û†Å∑","Û†Å∏","Û†Åπ","Û†Å∫","Û†Åø"],hasInvi:e=>new RegExp("‚Äå([\\s\\S]+?)Û†Å°","u").test(e),decode:e=>{const t=new RegExp("‚Äå([\\s\\S]+?)Û†Å°","u").exec(e);if(!t)return e;const n=i.CHARS.reduce(((e,t,n)=>(e[t]=n,e)),{}),o=Array.from(t[1]);let r="";for(let e=0;e<o.length;e+=5){let t=o.slice(e,e+5);if(t.length<5)break;let i=t.map((e=>n[e])).reverse().reduce(((e,t,n)=>e+t*Math.pow(26,n)),0);r+=String.fromCodePoint(i)}return r},encode:e=>{if(!e)return"";let t="";for(let n of e){let e=n.codePointAt(0),o=[];for(;e>0;)o.push(e%26),e=Math.floor(e/26);for(;o.length<5;)o.push(0);t+=o.reverse().map((e=>i.CHARS[e])).join("")}return i.START+t+i.END}};async function r(t,n,i=[],r=null){if(!e.botApiKey||o)return null;o=!0;const l=r||`STRICT CONSTRAINT: 1. Detect language and reply in THAT SAME LANGUAGE. 2. Address as "${t}". DO NOT use "Anh/Ch·ªã". 3. Role: ${e.botContext}`,s=`${i.join("\n")}\n\nUser: ${n}`;try{const t=e.botModel.startsWith("gemini"),n=t?`https://generativelanguage.googleapis.com/v1beta/models/${e.botModel}:generateContent?key=${e.botApiKey}`:"https://api.mistral.ai/v1/chat/completions",o=t?{contents:[{role:"user",parts:[{text:l}]},{role:"model",parts:[{text:"OK"}]},{role:"user",parts:[{text:s}]}]}:{model:e.botModel,messages:[{role:"system",content:l},{role:"user",content:s}]},i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",...t?{}:{Authorization:`Bearer ${e.botApiKey}`}},body:JSON.stringify(o)}),r=await i.json();return t?r?.candidates?.[0]?.content?.parts?.[0]?.text:r?.choices?.[0]?.message?.content}catch(e){return null}finally{setTimeout((()=>o=!1),1e3)}}function l(t,n=null,o=!1){if(n){const e=n.querySelectorAll(".actions .ant-col");if(e.length>0){const t=e[e.length-1].querySelector("button");t&&t.click()}}setTimeout((()=>{const n=document.querySelector(".input-send-box textarea")||document.querySelector("textarea"),r=document.querySelector("button.send-box")||document.querySelector("button[type='submit']");n&&r&&(n.value=e.botUseInvi&&o?i.encode(t):`[AI]: ${t}`,n.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{r.disabled||r.click()}),350))}),400)}function s(t,n="history"){let o=document.getElementById("ai-premium-modal");o&&o.remove();const i=document.createElement("div");i.id="ai-premium-modal",Object.assign(i.style,{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"450px",maxHeight:"80vh",background:"rgba(255, 255, 255, 0.98)",backdropFilter:"blur(15px)",border:"1px solid rgba(114, 46, 209, 0.4)",borderRadius:"24px",zIndex:"10001",boxShadow:"0 25px 60px rgba(0,0,0,0.2)",display:"flex",flexDirection:"column",padding:"24px",fontFamily:"'Segoe UI', Roboto, sans-serif"});const r="history"===n?"üìú L·ªãch s·ª≠ h·ªôi tho·∫°i":"‚ú® AI T√≥m t·∫Øt";i.innerHTML=`\n      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; border-bottom:1.5px solid #f0f0f0; padding-bottom:12px;">\n        <span style="font-weight:800; color:#722ed1; font-size:20px;">${r}</span>\n        <span id="close-modal" style="cursor:pointer; font-size:24px; color:#bfbfbf;">&times;</span>\n      </div>\n      <div id="modal-body" style="flex:1; overflow-y:auto; padding-right:8px; font-size:14px; line-height:1.7; color:#434343;">\n        ${t}\n      </div>\n      <div style="margin-top:20px; display:flex; gap:12px;">\n        ${"history"===n&&e.botSummaryEnabled?'<button id="btn-do-summary" style="flex:1.5; padding:12px; border-radius:12px; border:none; background:linear-gradient(135deg, #722ed1 0%, #9254de 100%); color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 12px rgba(114,46,209,0.3);">G·ª≠i t√≥m t·∫Øt v√†o Chat</button>':""}\n        <button id="btn-copy" style="flex:1; padding:12px; border-radius:12px; border:1px solid #d9d9d9; background:white; color:#595959; font-weight:600; cursor:pointer;">Sao ch√©p</button>\n      </div>\n    `,document.body.appendChild(i),document.getElementById("close-modal").onclick=()=>i.remove(),document.getElementById("btn-copy").onclick=()=>{navigator.clipboard.writeText(document.getElementById("modal-body").innerText),document.getElementById("btn-copy").innerText="‚úÖ ƒê√£ ch√©p!",setTimeout((()=>document.getElementById("btn-copy").innerText="Sao ch√©p"),2e3)},"history"===n&&e.botSummaryEnabled&&(document.getElementById("btn-do-summary").onclick=()=>a(!0))}async function a(t=!1){if(!e.botSummaryEnabled||n.length<2)return;const o=document.getElementById("ai-summary-btn"),i=o.innerText;o.innerText="‚è≥...";const a=n.slice(-50).map((e=>`${e.name}: ${e.text}`)).join("\n"),d=await r("L√Ω M·∫∑c S·∫ßu",`T√≥m t·∫Øt n·ªôi dung h·ªôi tho·∫°i n√†y th·∫≠t chuy√™n nghi·ªáp, ng·∫Øn g·ªçn, d√πng bullet points:\n\n${a}`,[],"B·∫°n l√† tr·ª£ l√Ω t√≥m t·∫Øt chuy√™n nghi·ªáp.");d&&(t?(l("‚ú® T√ìM T·∫ÆT H·ªòI THO·∫†I:\n"+d,null,!1),document.getElementById("ai-premium-modal")?.remove()):s(d.replace(/\n/g,"<br>"),"summary")),o.innerText=i}function d(){let t=document.getElementById("ai-summary-btn");if(e.botHistoryBtnEnabled){if(!t){t=document.createElement("div"),t.id="ai-summary-btn",t.innerText="L·ªãch s·ª≠",Object.assign(t.style,{position:"fixed",bottom:"120px",right:"30px",width:"68px",height:"68px",background:"linear-gradient(135deg, #722ed1 0%, #531dab 100%)",color:"white",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",cursor:"pointer",zIndex:"10000",boxShadow:"0 8px 25px rgba(114,46,209,0.4)",fontWeight:"bold",textAlign:"center",userSelect:"none",transition:"all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)"}),t.onmouseover=()=>{t.style.transform="scale(1.1) rotate(5deg)"},t.onmouseout=()=>{t.style.transform="scale(1) rotate(0deg)"};let o=[0,0],i=!1,r=[0,0];t.addEventListener("mousedown",(e=>{i=!0,r=[e.clientX,e.clientY],o=[t.offsetLeft-e.clientX,t.offsetTop-e.clientY]}),!0),document.addEventListener("mouseup",(e=>{if(i){i=!1;if(Math.sqrt(Math.pow(e.clientX-r[0],2)+Math.pow(e.clientY-r[1],2))<5){s(n.length>0?n.map((e=>`<div style="margin-bottom:12px; padding:10px; background:#f7f7f7; border-radius:10px; border-left:4px solid #722ed1;"><b style="color:#722ed1; display:block; margin-bottom:4px; font-size:12px;">${e.name}</b><span style="color:#262626;">${e.text}</span></div>`)).join(""):'<div style="text-align:center; color:#999; margin-top:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>',"history")}}}),!0),t.addEventListener("contextmenu",(t=>{t.preventDefault(),e.botSummaryEnabled&&a(!1)})),document.addEventListener("mousemove",(e=>{i&&(t.style.left=e.clientX+o[0]+"px",t.style.top=e.clientY+o[1]+"px",t.style.right="auto",t.style.bottom="auto")}),!0),document.body.appendChild(t)}}else t&&t.remove()}function c(){if(!e.botEnabled)return;d();const o=document.querySelectorAll(".sc-bMvGRv");0!==o.length&&o.forEach((s=>{const a=s.getAttribute("data-message-id")||s.id;if(!a||t.has(a))return;t.add(a);const d=s.querySelector(".main-content p"),c=s.querySelector(".name span:first-child")?.innerText.trim()||(s.closest(".me, .owner")?"T√¥i":"User");if(d){let e=d.innerText.trim(),t=i.hasInvi(e)?i.decode(e):e;t&&!t.startsWith("[AI]")&&(n.push({name:c,text:t,id:a}),n.length>200&&n.shift())}if(s===o[o.length-1]&&!s.closest(".me, .owner, .self")){const t=s.querySelector(".join");if(t){const n=t.querySelector("strong")?.innerText.trim();return void(n&&l((e.botWelcomeMsg||"Ch√†o [name]!").replace("[name]",n),null,!1))}const n=s.querySelectorAll(".main-quote-content"),o=[];n.forEach((e=>{let t=e.innerText.trim();o.push(`- Quote: "${i.hasInvi(t)?i.decode(t):t}"`)}));const a=s.querySelector(".main-content p");if(a){let e=a.innerText.trim(),t=i.hasInvi(e),n=t?i.decode(e):e;n&&!n.startsWith("[AI]")&&r(c,n,o).then((e=>{e&&l(e,s,t)}))}}}))}const m=()=>chrome.storage.local.get(null,(t=>{e={...e,...t},d()}));let u;m(),chrome.storage.onChanged.addListener(m),new MutationObserver((e=>{e.some((e=>e.addedNodes.length>0))&&(clearTimeout(u),u=setTimeout(c,600))})).observe(document.body,{childList:!0,subtree:!0})}();