!function(){"use strict";let e={botEnabled:!1,botApiKey:"",botContext:"",botUseInvi:!1,botModel:"gemini-2.0-flash",botWelcomeEnabled:!1,botWelcomeMsg:"",botHistoryBtnEnabled:!1,botSummaryEnabled:!1,uiLang:"vi"},t=new Set,n=[],o=!1;const i={vi:{history:"Lá»‹ch sá»­",summary:"TÃ³m táº¯t",close:"ÄÃ³ng",copy:"Sao chÃ©p",copied:"âœ… ÄÃ£ chÃ©p!",historyTitle:"ðŸ“œ Lá»‹ch sá»­ há»™i thoáº¡i",summaryTitle:"âœ¨ AI TÃ³m táº¯t",sendSummary:"Gá»­i tÃ³m táº¯t vÃ o Chat",processing:"â³...",noData:"ChÆ°a cÃ³ dá»¯ liá»‡u...",aiPrefix:"[AI]: ",sumPrefix:"âœ¨ TÃ“M Táº®T Há»˜I THOáº I:\n",sumPrompt:"TÃ³m táº¯t ná»™i dung há»™i thoáº¡i nÃ y tháº­t chuyÃªn nghiá»‡p, ngáº¯n gá»n, dÃ¹ng bullet points:",sumRole:"Báº¡n lÃ  trá»£ lÃ½ tÃ³m táº¯t chuyÃªn nghiá»‡p.",welcome:"ChÃ o má»«ng [name]!"},en:{history:"History",summary:"Summary",close:"Close",copy:"Copy",copied:"âœ… Copied!",historyTitle:"ðŸ“œ Chat History",summaryTitle:"âœ¨ AI Summary",sendSummary:"Send Summary to Chat",processing:"â³...",noData:"No data available!",aiPrefix:"[AI]: ",sumPrefix:"âœ¨ CONVERSATION SUMMARY:\n",sumPrompt:"Summarize this conversation professionally and concisely using bullet points:",sumRole:"You are a professional summary assistant.",welcome:"Welcome [name]!"}},r=t=>(i[e.uiLang]||i.vi)[t],s={START:"â€Œ",END:"ó ¡",CHARS:["ó ¢","ó £","ó ¤","ó ¥","ó ¦","ó §","ó ¨","ó ©","ó ª","ó «","ó ¬","ó ­","ó ®","ó ¯","ó °","ó ±","ó ²","ó ³","ó ´","ó µ","ó ¶","ó ·","ó ¸","ó ¹","ó º","ó ¿"],hasInvi:e=>new RegExp("â€Œ([\\s\\S]+?)ó ¡","u").test(e),decode:e=>{const t=new RegExp("â€Œ([\\s\\S]+?)ó ¡","u").exec(e);if(!t)return e;const n=s.CHARS.reduce(((e,t,n)=>(e[t]=n,e)),{}),o=Array.from(t[1]);let i="";for(let e=0;e<o.length;e+=5){let t=o.slice(e,e+5);if(t.length<5)break;let r=t.map((e=>n[e])).reverse().reduce(((e,t,n)=>e+t*Math.pow(26,n)),0);i+=String.fromCodePoint(r)}return i},encode:e=>{if(!e)return"";let t="";for(let n of e){let e=n.codePointAt(0),o=[];for(;e>0;)o.push(e%26),e=Math.floor(e/26);for(;o.length<5;)o.push(0);t+=o.reverse().map((e=>s.CHARS[e])).join("")}return s.START+t+s.END}};async function a(t,n,i=[],r=null){if(!e.botApiKey||o)return null;o=!0;const s=r||`STRICT CONSTRAINT: 1. Detect language and reply in THAT SAME LANGUAGE. 2. Address as "${t}". DO NOT use "Anh/Chá»‹". 3. Role: ${e.botContext}`,a=`${i.join("\n")}\n\nUser: ${n}`;try{const t=e.botModel.startsWith("gemini"),n=t?`https://generativelanguage.googleapis.com/v1beta/models/${e.botModel}:generateContent?key=${e.botApiKey}`:"https://api.mistral.ai/v1/chat/completions",o=t?{contents:[{role:"user",parts:[{text:s}]},{role:"model",parts:[{text:"OK"}]},{role:"user",parts:[{text:a}]}]}:{model:e.botModel,messages:[{role:"system",content:s},{role:"user",content:a}]},i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",...t?{}:{Authorization:`Bearer ${e.botApiKey}`}},body:JSON.stringify(o)}),r=await i.json();return t?r?.candidates?.[0]?.content?.parts?.[0]?.text:r?.choices?.[0]?.message?.content}catch(e){return null}finally{setTimeout((()=>o=!1),1e3)}}function l(t,n=null,o=!1){if(n){const e=n.querySelectorAll(".actions .ant-col");if(e.length>0){const t=e[e.length-1].querySelector("button");t&&t.click()}}setTimeout((()=>{const n=document.querySelector(".input-send-box textarea")||document.querySelector("textarea"),i=document.querySelector("button.send-box")||document.querySelector("button[type='submit']");if(!n||!i)return;const a=`${r("aiPrefix")}${t}`;n.value=e.botUseInvi&&o?s.encode(a):a,n.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{i.disabled||i.click()}),350)}),400)}function d(t,n="history"){let o=document.getElementById("ai-premium-modal");o&&o.remove();const i=document.createElement("div");i.id="ai-premium-modal",Object.assign(i.style,{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"450px",maxHeight:"80vh",background:"rgba(255, 255, 255, 0.98)",backdropFilter:"blur(15px)",border:"1px solid rgba(114, 46, 209, 0.4)",borderRadius:"24px",zIndex:"10001",boxShadow:"0 25px 60px rgba(0,0,0,0.2)",display:"flex",flexDirection:"column",padding:"24px",fontFamily:"'Segoe UI', Roboto, sans-serif"});const s=r("history"===n?"historyTitle":"summaryTitle");i.innerHTML=`\n      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; border-bottom:1.5px solid #f0f0f0; padding-bottom:12px;">\n        <span style="font-weight:800; color:#722ed1; font-size:20px;">${s}</span>\n        <span id="close-modal" style="cursor:pointer; font-size:24px; color:#bfbfbf;">&times;</span>\n      </div>\n      <div id="modal-body" style="flex:1; overflow-y:auto; padding-right:8px; font-size:14px; line-height:1.7; color:#434343;">\n        ${t}\n      </div>\n      <div style="margin-top:20px; display:flex; gap:12px;">\n        ${"history"===n&&e.botSummaryEnabled?`<button id="btn-do-summary" style="flex:1.5; padding:12px; border-radius:12px; border:none; background:linear-gradient(135deg, #722ed1 0%, #9254de 100%); color:white; font-weight:bold; cursor:pointer;">${r("sendSummary")}</button>`:""}\n        <button id="btn-copy" style="flex:1; padding:12px; border-radius:12px; border:1px solid #d9d9d9; background:white; color:#595959; font-weight:600; cursor:pointer;">${r("copy")}</button>\n      </div>\n    `,document.body.appendChild(i),document.getElementById("close-modal").onclick=()=>i.remove(),document.getElementById("btn-copy").onclick=()=>{navigator.clipboard.writeText(document.getElementById("modal-body").innerText),document.getElementById("btn-copy").innerText=r("copied"),setTimeout((()=>document.getElementById("btn-copy").innerText=r("copy")),2e3)},"history"===n&&e.botSummaryEnabled&&(document.getElementById("btn-do-summary").onclick=()=>c(!0))}async function c(t=!1){if(!e.botSummaryEnabled||n.length<2)return;const o=document.getElementById("ai-summary-btn"),i=o?o.innerText:"";o&&(o.innerText=r("processing"));const s=n.slice(-50).map((e=>`${e.name}: ${e.text}`)).join("\n"),c=await a("Assistant",`${r("sumPrompt")}\n\n${s}`,[],r("sumRole"));c&&(t?(l(r("sumPrefix")+c,null,!1),document.getElementById("ai-premium-modal")?.remove()):d(c.replace(/\n/g,"<br>"),"summary")),o&&(o.innerText=i)}function m(){let t=document.getElementById("ai-summary-btn");if(e.botHistoryBtnEnabled)if(t)t.innerText=r("history");else{t=document.createElement("div"),t.id="ai-summary-btn",t.innerText=r("history"),Object.assign(t.style,{position:"fixed",bottom:"120px",right:"30px",width:"68px",height:"68px",background:"linear-gradient(135deg, #722ed1 0%, #531dab 100%)",color:"white",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",cursor:"pointer",zIndex:"10000",boxShadow:"0 8px 25px rgba(114,46,209,0.4)",fontWeight:"bold",textAlign:"center",userSelect:"none",transition:"all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)"}),t.onmouseover=()=>{t.style.transform="scale(1.1) rotate(5deg)"},t.onmouseout=()=>{t.style.transform="scale(1) rotate(0deg)"};let o=[0,0],i=!1,s=[0,0];t.addEventListener("mousedown",(e=>{i=!0,s=[e.clientX,e.clientY],o=[t.offsetLeft-e.clientX,t.offsetTop-e.clientY]}),!0),document.addEventListener("mouseup",(e=>{if(i){i=!1;if(Math.sqrt(Math.pow(e.clientX-s[0],2)+Math.pow(e.clientY-s[1],2))<5){d(n.length>0?n.map((e=>`<div style="margin-bottom:12px; padding:10px; background:#f7f7f7; border-radius:10px; border-left:4px solid #722ed1;"><b style="color:#722ed1; display:block; margin-bottom:4px; font-size:12px;">${e.name}</b><span style="color:#262626;">${e.text}</span></div>`)).join(""):`<div style="text-align:center; color:#999; margin-top:20px;">${r("noData")}</div>`,"history")}}}),!0),t.addEventListener("contextmenu",(t=>{t.preventDefault(),e.botSummaryEnabled&&c(!1)})),document.addEventListener("mousemove",(e=>{i&&(t.style.left=e.clientX+o[0]+"px",t.style.top=e.clientY+o[1]+"px",t.style.right="auto",t.style.bottom="auto")}),!0),document.body.appendChild(t)}else t&&t.remove()}function u(){if(!e.botEnabled)return;m();const o=document.querySelectorAll(".sc-bMvGRv");0!==o.length&&o.forEach((i=>{const d=i.getAttribute("data-message-id")||i.id;if(!d||t.has(d))return;const c=i.querySelector(".join");if(c&&e.botWelcomeEnabled){const n=c.querySelector("strong")?.innerText.trim();if(n){t.add(d);return void l((e.botWelcomeMsg||r("welcome")).replace("[name]",n),null,!1)}}const m=i.querySelector(".main-content p");if(m){let c=m.innerText.trim(),u=s.hasInvi(c)?s.decode(c):c;const p=r("aiPrefix");if(u&&(u.startsWith(p)||u.startsWith("âœ¨ TÃ“M Táº®T")||u.startsWith("âœ¨ CONVERSATION")))return void t.add(d);if(u&&!u.startsWith(p)){const t=i.querySelector(".name span:first-child")?.innerText.trim()||(i.closest(".me, .owner")?"vi"===e.uiLang?"TÃ´i":"Me":"User");n.push({name:t,text:u,id:d}),n.length>200&&n.shift()}if(i!==o[o.length-1]||i.closest(".me, .owner, .self"))t.add(d);else{t.add(d);const e=i.querySelector(".name span:first-child")?.innerText.trim()||"User",n=i.querySelectorAll(".main-quote-content"),o=[];n.forEach((e=>{let t=e.innerText.trim();o.push(`- Quote: "${s.hasInvi(t)?s.decode(t):t}"`)})),a(e,u,o).then((e=>{e&&l(e,i,s.hasInvi(c))}))}}}))}const p=()=>chrome.storage.local.get(null,(t=>{e={...e,...t},m()}));let y;p(),chrome.storage.onChanged.addListener(p),new MutationObserver((e=>{e.some((e=>e.addedNodes.length>0))&&(clearTimeout(y),y=setTimeout(u,600))})).observe(document.body,{childList:!0,subtree:!0})}();