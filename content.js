!function(){"use strict";let e={botEnabled:!1,botApiKey:"",botContext:"",botUseInvi:!1,botModel:"gemini-2.0-flash",botWelcomeEnabled:!1,botWelcomeMsg:"",botSummaryBtnEnabled:!1},t=new Set,n=!1;const o=(()=>{const e=["󠁢","󠁣","󠁤","󠁥","󠁦","󠁧","󠁨","󠁩","󠁪","󠁫","󠁬","󠁭","󠁮","󠁯","󠁰","󠁱","󠁲","󠁳","󠁴","󠁵","󠁶","󠁷","󠁸","󠁹","󠁺","󠁿"],t=e.length,n=e.reduce(((e,t,n)=>(e[t]=n,e)),{}),o=new RegExp("‌([\\s\\S]+?)󠁡");return{encode:n=>{if(!n)return"";let o="";for(let r of n){let n=r.codePointAt(0),i=[];for(;n>0;)i.push(n%t),n=Math.floor(n/t);for(;i.length<5;)i.push(0);o+=i.reverse().map((t=>e[t])).join("")}return"‌"+o+"󠁡"},decode:e=>{const r=o.exec(e);if(!r)return e;const i=Array.from(r[1]);let l="";for(let e=0;e<i.length;e+=5){let o=i.slice(e,e+5);if(o.length<5)break;let r=o.map((e=>n[e])).reverse().reduce(((e,n,o)=>e+n*Math.pow(t,o)),0);l+=String.fromCodePoint(r)}return l},hasInvi:e=>o.test(e)}})();async function r(t,o,r=[],i=null){if(!e.botApiKey||n)return null;n=!0;const l=i||`STRICT CONSTRAINT: 1. Detect language and reply in THAT SAME LANGUAGE. 2. Address as "${t}". DO NOT use "Anh/Chị". 3. Role: ${e.botContext}`,s=`${r.length>0?"Quotes:\n"+r.join("\n")+"\n\n":""}Message from "${t}": ${o}`;try{const t=e.botModel.startsWith("gemini"),n=t?`https://generativelanguage.googleapis.com/v1beta/models/${e.botModel}:generateContent?key=${e.botApiKey}`:"https://api.mistral.ai/v1/chat/completions",o=t?{contents:[{role:"user",parts:[{text:l}]},{role:"model",parts:[{text:"Confirmed."}]},{role:"user",parts:[{text:s}]}]}:{model:e.botModel,messages:[{role:"system",content:l},{role:"user",content:s}]},r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",...t?{}:{Authorization:`Bearer ${e.botApiKey}`}},body:JSON.stringify(o)}),i=await r.json();return t?i?.candidates?.[0]?.content?.parts?.[0]?.text:i?.choices?.[0]?.message?.content}catch(e){return null}finally{setTimeout((()=>{n=!1}),1e3)}}function i(t,n=null,r=!1){if(n){const e=n.querySelectorAll(".actions .ant-col");if(e.length>0){const t=e[e.length-1].querySelector("button");t&&t.click()}}setTimeout((()=>{const n=document.querySelector(".input-send-box textarea")||document.querySelector("textarea"),i=document.querySelector("button.send-box")||document.querySelector("button[type='submit']");if(!n||!i)return;const l=e.botUseInvi&&r?o.encode(t):`[AI]: ${t}`;n.value=l,n.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{i.disabled||i.click()}),350)}),400)}function l(){let t=document.getElementById("ai-summary-btn");if(e.botSummaryBtnEnabled){if(!t){t=document.createElement("div"),t.id="ai-summary-btn",t.innerText="Tóm tắt",Object.assign(t.style,{position:"fixed",bottom:"120px",right:"30px",width:"65px",height:"65px",backgroundColor:"#722ed1",color:"white",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",cursor:"pointer",zIndex:"10000",boxShadow:"0 4px 15px rgba(114,46,209,0.5)",fontWeight:"bold",textAlign:"center",userSelect:"none"});let e=[0,0],n=!1,l=0;t.addEventListener("mousedown",(o=>{n=!0,l=Date.now(),e=[t.offsetLeft-o.clientX,t.offsetTop-o.clientY]}),!0),document.addEventListener("mouseup",(()=>{n=!1}),!0),document.addEventListener("mousemove",(o=>{n&&(t.style.left=o.clientX+e[0]+"px",t.style.top=o.clientY+e[1]+"px",t.style.right="auto",t.style.bottom="auto")}),!0),t.addEventListener("click",(()=>{Date.now()-l<200&&async function(){const e=document.querySelectorAll(".sc-bMvGRv"),t=Array.from(e).map((e=>{const t=e.querySelector(".name")?.innerText.trim()||"User",n=e.querySelector(".main-content p");if(!n)return null;let r=n.innerText.trim();return r=o.hasInvi(r)?o.decode(r):r,`${t}: ${r}`})).filter((e=>null!==e)).slice(-50).join("\n");if(!t)return alert("Không tìm thấy tin nhắn nào để tóm tắt!");console.log("Đang tóm tắt nội dung sau:\n",t);const n=await r("Hệ thống",`Hãy tóm tắt nội dung cuộc hội thoại dưới đây một cách chi tiết nhưng ngắn gọn: \n\n${t}`,[],"Bạn là trợ lý tóm tắt hội thoại chuyên nghiệp.");n&&i("BẢN TÓM TẮT HỘI THOẠI: "+n,null,!1)}()})),document.body.appendChild(t)}}else t&&t.remove()}function s(){if(!e.botEnabled)return;l();const n=document.querySelectorAll(".sc-bMvGRv");if(0===n.length)return;const s=n[n.length-1],c=s.getAttribute("data-message-id")||s.id;if(!c||t.has(c))return;if(t.add(c),t.size>100){const e=t.values().next().value;t.delete(e)}if(s.closest(".me, .owner, .my-message, .self"))return;if(e.botWelcomeEnabled){const t=s.querySelector(".join");if(t){const n=t.querySelector("strong")?.innerText.trim();if(n)return void i((e.botWelcomeMsg||"Chào mừng [name]!").replace("[name]",n),null,!1)}}const a=s.querySelectorAll(".main-quote-content");let u=[];a.forEach((e=>{let t=e.innerText.trim();u.push(`- Quote: "${o.hasInvi(t)?o.decode(t):t}"`)}));const d=s.querySelector(".main-content p");if(!d)return;let m=d.innerText.trim(),h=o.hasInvi(m),b=h?o.decode(m):m;if(!b||b.startsWith("[AI]"))return;r(s.querySelector(".name span:first-child")?.innerText.trim()||"User",b,u).then((e=>{e&&i(e,s,h)}))}const c=()=>chrome.storage.local.get(null,(t=>{e={...e,...t},l()}));let a;c(),chrome.storage.onChanged.addListener(c);new MutationObserver((e=>{e.some((e=>e.addedNodes.length>0))&&(clearTimeout(a),a=setTimeout(s,600))})).observe(document.body,{childList:!0,subtree:!0})}();