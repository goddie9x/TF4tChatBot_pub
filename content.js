!function(){"use strict";let e={botEnabled:!1,botApiKey:"",botContext:"",botUseInvi:!1,botModel:"gemini-2.0-flash",botWelcomeEnabled:!1,botWelcomeMsg:"",botHistoryBtnEnabled:!1,botSummaryEnabled:!1,uiLang:"vi",botPauseReply:!1},t=new Set,o=[],n=!1;const i={vi:{history:"Lá»‹ch sá»­",summary:"TÃ³m táº¯t",close:"ÄÃ³ng",copy:"Sao chÃ©p",copied:"âœ… ÄÃ£ chÃ©p!",historyTitle:"ðŸ“œ Lá»‹ch sá»­ há»™i thoáº¡i",summaryTitle:"âœ¨ AI TÃ³m táº¯t",sendSummary:"Gá»­i tÃ³m táº¯t vÃ o Chat",processing:"â³...",noData:"ChÆ°a cÃ³ dá»¯ liá»‡u...",aiPrefix:"[AI]: ",sumPrefix:"âœ¨ TÃ“M Táº®T Há»˜I THOáº I:\n",sumPrompt:"HÃ£y tÃ³m táº¯t ná»™i dung há»™i thoáº¡i sau Ä‘Ã¢y má»™t cÃ¡ch chuyÃªn nghiá»‡p vÃ  ngáº¯n gá»n báº±ng cÃ¡c Ã½ chÃ­nh (bullet points):",sumRole:"Báº¡n lÃ  chuyÃªn gia tÃ³m táº¯t há»™i thoáº¡i.",welcome:"ChÃ o má»«ng [name]!",pauseOn:"â¸ AI: Táº¯t",pauseOff:"â–¶ AI: Báº­t"},en:{history:"History",summary:"Summary",close:"Close",copy:"Copy",copied:"âœ… Copied!",historyTitle:"ðŸ“œ Chat History",summaryTitle:"âœ¨ AI Summary",sendSummary:"Send Summary to Chat",processing:"â³...",noData:"No data available!",aiPrefix:"[AI]: ",welcome:"Welcome [name]!",pauseOn:"â¸ AI: Off",pauseOff:"â–¶ AI: On"}},s=t=>(i[e.uiLang]||i.vi)[t],r={START:"â€Œ",END:"ó ¡",CHARS:["ó ¢","ó £","ó ¤","ó ¥","ó ¦","ó §","ó ¨","ó ©","ó ª","ó «","ó ¬","ó ­","ó ®","ó ¯","ó °","ó ±","ó ²","ó ³","ó ´","ó µ","ó ¶","ó ·","ó ¸","ó ¹","ó º","ó ¿"],hasInvi:e=>new RegExp("â€Œ([\\s\\S]+?)ó ¡","u").test(e),decode:e=>{const t=new RegExp("â€Œ([\\s\\S]+?)ó ¡","u").exec(e);if(!t)return e;const o=Array.from(t[1]),n=r.CHARS.reduce(((e,t,o)=>(e[t]=o,e)),{});let i="";for(let e=0;e<o.length;e+=5){let t=o.slice(e,e+5);if(t.length<5)break;let s=t.map((e=>n[e])).reverse().reduce(((e,t,o)=>e+t*Math.pow(26,o)),0);i+=String.fromCodePoint(s)}return i},encode:e=>{if(!e)return"";let t="";for(let o of e){let e=o.codePointAt(0),n=[];for(;e>0;)n.push(e%26),e=Math.floor(e/26);for(;n.length<5;)n.push(0);t+=n.reverse().map((e=>r.CHARS[e])).join("")}return r.START+t+r.END}};async function a(t,o,i=[],s=null){if(!e.botApiKey||n)return null;n=!0;const r=t||"User",a=o||"",l=Array.isArray(i)?i.filter((e=>e)).join("\n"):"",d=s||`Role: ${e.botContext||"Assistant"}\nDetect language and reply in THAT SAME LANGUAGE. Address as "${r}".`,c=l?`${l}\n\nUser ${r}: ${a}`:`User ${r}: ${a}`;try{const t=e.botModel.startsWith("gemini"),o=t?`https://generativelanguage.googleapis.com/v1beta/models/${e.botModel}:generateContent?key=${e.botApiKey}`:"https://api.mistral.ai/v1/chat/completions",n=t?{contents:[{role:"user",parts:[{text:d}]},{role:"model",parts:[{text:"OK"}]},{role:"user",parts:[{text:c}]}]}:{model:e.botModel,messages:[{role:"system",content:d},{role:"user",content:c}]},i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...t?{}:{Authorization:`Bearer ${e.botApiKey}`}},body:JSON.stringify(n)}),s=await i.json(),r=t?s?.candidates?.[0]?.content?.parts?.[0]?.text:s?.choices?.[0]?.message?.content;return r?r.trim():null}catch(e){return null}finally{setTimeout((()=>n=!1),1e3)}}function l(t,o=null,n=!1){const i=document.querySelector(".input-send-box textarea")||document.querySelector("textarea"),a=document.querySelector("button.send-box")||document.querySelector("button[type='submit']");if(i&&a&&t){if(o){const e=o.querySelectorAll(".actions .ant-col");if(e.length>0){const t=e[e.length-1].querySelector("button");t&&t.click()}}setTimeout((()=>{const o=`${s("aiPrefix")}${t}`;i.value=e.botUseInvi&&n?r.encode(o):o,i.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{a.disabled||a.click()}),350)}),400)}}function d(t,o="history"){let n=document.getElementById("ai-premium-modal");n&&n.remove();const i=document.createElement("div");i.id="ai-premium-modal",Object.assign(i.style,{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"450px",maxHeight:"80vh",background:"rgba(255, 255, 255, 0.98)",backdropFilter:"blur(15px)",border:"1px solid rgba(114, 46, 209, 0.4)",borderRadius:"24px",zIndex:"10001",boxShadow:"0 25px 60px rgba(0,0,0,0.2)",display:"flex",flexDirection:"column",padding:"24px",fontFamily:"'Segoe UI', Roboto, sans-serif"});const r=s("history"===o?"historyTitle":"summaryTitle");i.innerHTML=`<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; border-bottom:1.5px solid #f0f0f0; padding-bottom:12px;"><span style="font-weight:800; color:#722ed1; font-size:20px;">${r}</span><span id="close-modal" style="cursor:pointer; font-size:24px; color:#bfbfbf;">&times;</span></div><div id="modal-body" style="flex:1; overflow-y:auto; padding-right:8px; font-size:14px; line-height:1.7; color:#434343;">${t}</div><div style="margin-top:20px; display:flex; gap:12px;">${"history"===o&&e.botSummaryEnabled?`<button id="btn-do-summary" style="flex:1.5; padding:12px; border-radius:12px; border:none; background:linear-gradient(135deg, #722ed1 0%, #9254de 100%); color:white; font-weight:bold; cursor:pointer;">${s("sendSummary")}</button>`:""}<button id="btn-copy" style="flex:1; padding:12px; border-radius:12px; border:1px solid #d9d9d9; background:white; color:#595959; font-weight:600; cursor:pointer;">${s("copy")}</button></div>`,document.body.appendChild(i),document.getElementById("close-modal").onclick=()=>i.remove(),document.getElementById("btn-copy").onclick=()=>{navigator.clipboard.writeText(document.getElementById("modal-body").innerText),document.getElementById("btn-copy").innerText=s("copied"),setTimeout((()=>document.getElementById("btn-copy").innerText=s("copy")),2e3)},document.getElementById("btn-do-summary")&&(document.getElementById("btn-do-summary").onclick=()=>c(!0))}async function c(t=!1){if(!e.botSummaryEnabled||o.length<2)return;const n=document.getElementById("ai-summary-btn"),i=n?n.innerText:"";n&&(n.innerText=s("processing"));const r=o.slice(-60).map((e=>`${e.name}: ${e.text}`)).join("\n"),c=`You are a professional summarizer. Task: ${s("sumPrompt")} Language: ${"vi"===e.uiLang?"Vietnamese":"English"}.`,m=await a("Assistant",r,[],c);m&&(t?(l(m,null,!1),document.getElementById("ai-premium-modal")?.remove()):d(m.replace(/\n/g,"<br>"),"summary")),n&&(n.innerText=i)}function m(){let n=document.getElementById("ai-summary-btn"),i=document.getElementById("ai-pause-btn");if(e.botHistoryBtnEnabled){if(n)n.innerText=s("history");else{n=document.createElement("div"),n.id="ai-summary-btn",n.innerText=s("history"),Object.assign(n.style,{position:"fixed",bottom:"120px",right:"30px",width:"68px",height:"68px",background:"linear-gradient(135deg, #722ed1 0%, #531dab 100%)",color:"white",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",cursor:"pointer",zIndex:"10000",boxShadow:"0 8px 25px rgba(114,46,209,0.4)",fontWeight:"bold",textAlign:"center",userSelect:"none",transition:"all 0.3s"});let t=[0,0],i=!1,r=[0,0];n.addEventListener("mousedown",(e=>{i=!0,r=[e.clientX,e.clientY],t=[n.offsetLeft-e.clientX,n.offsetTop-e.clientY]}),!0),document.addEventListener("mouseup",(e=>{if(i&&(i=!1,Math.sqrt(Math.pow(e.clientX-r[0],2)+Math.pow(e.clientY-r[1],2))<5)){d(o.map((e=>`<div style="margin-bottom:12px; padding:10px; background:#f7f7f7; border-radius:10px; border-left:4px solid #722ed1;"><b style="color:#722ed1; display:block; margin-bottom:4px; font-size:12px;">${e.name}</b><span>${e.text}</span></div>`)).join("")||s("noData"),"history")}}),!0),n.addEventListener("contextmenu",(t=>{t.preventDefault(),e.botSummaryEnabled&&c(!1)})),document.addEventListener("mousemove",(e=>{i&&(n.style.left=e.clientX+t[0]+"px",n.style.top=e.clientY+t[1]+"px",n.style.right="auto",n.style.bottom="auto")}),!0),document.body.appendChild(n)}if(i)i.innerText=e.botPauseReply?s("pauseOn"):s("pauseOff"),i.style.background=e.botPauseReply?"#ff4d4f":"#52c41a";else{i=document.createElement("div"),i.id="ai-pause-btn",Object.assign(i.style,{position:"fixed",bottom:"120px",right:"105px",width:"65px",height:"65px",background:e.botPauseReply?"#ff4d4f":"#52c41a",color:"white",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",cursor:"pointer",zIndex:"10000",boxShadow:"0 8px 25px rgba(0,0,0,0.2)",fontWeight:"bold",textAlign:"center",userSelect:"none",transition:"all 0.3s"}),i.innerText=e.botPauseReply?s("pauseOn"):s("pauseOff");let o=[0,0],n=!1,r=[0,0];i.addEventListener("mousedown",(e=>{n=!0,r=[e.clientX,e.clientY],o=[i.offsetLeft-e.clientX,i.offsetTop-e.clientY]}),!0),document.addEventListener("mouseup",(o=>{if(n&&(n=!1,Math.sqrt(Math.pow(o.clientX-r[0],2)+Math.pow(o.clientY-r[1],2))<5)){if(e.botPauseReply){const e=document.querySelectorAll(".sc-bMvGRv, .message");e.length>0&&t.delete(e[e.length-1].getAttribute("data-message-id")||e[e.length-1].id)}chrome.storage.local.set({botPauseReply:!e.botPauseReply})}}),!0),document.addEventListener("mousemove",(e=>{n&&(i.style.left=e.clientX+o[0]+"px",i.style.top=e.clientY+o[1]+"px",i.style.right="auto",i.style.bottom="auto")}),!0),document.body.appendChild(i)}}else n&&n.remove(),i&&i.remove()}function u(){if(!e.botEnabled)return;m();const n=document.querySelectorAll(".sc-bMvGRv, .message");0!==n.length&&n.forEach(((i,d)=>{const c=i.getAttribute("data-message-id")||i.id||`msg-${d}`;if(t.has(c))return;const m=i.querySelector(".join")||i.querySelector(".system-message");if(m&&e.botWelcomeEnabled){const o=m.querySelector("strong")?.innerText.trim();if(o)return t.add(c),void l((e.botWelcomeMsg||s("welcome")).replace("[name]",o),null,!1)}const u=i.querySelector(".main-content p");if(u){let m=u.innerText.trim(),p=r.hasInvi(m)?r.decode(m):m;const b=s("aiPrefix");if(p.startsWith(b)||p.startsWith("âœ¨"))return void t.add(c);const y=i.querySelector(".name span:first-child")?.innerText.trim()||(i.closest(".me, .owner")?"TÃ´i":"User");if(i.closest(".me, .owner, .self")||(o.push({name:y,text:p,id:c}),o.length>200&&o.shift()),d!==n.length-1||i.closest(".me, .owner, .self"))t.add(c);else{if(t.add(c),e.botPauseReply)return;const o=[];i.querySelectorAll(".main-quote-content").forEach((e=>o.push(`- Quote: "${e.innerText.trim()}"`))),a(y,p,o).then((e=>{e&&l(e,i,r.hasInvi(m))}))}}}))}const p=()=>chrome.storage.local.get(null,(t=>{const o=e.botPauseReply;e=Object.assign(e,t),m(),o&&!e.botPauseReply&&u()}));let b;p(),chrome.storage.onChanged.addListener(p),new MutationObserver((e=>{e.some((e=>e.addedNodes.length>0))&&(clearTimeout(b),b=setTimeout(u,600))})).observe(document.body,{childList:!0,subtree:!0})}();