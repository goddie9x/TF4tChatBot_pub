!function(){"use strict";let e={botEnabled:!1,botApiKey:"",botContext:"",botUseInvi:!1,botModel:"gemini-2.0-flash",botWelcomeEnabled:!1,botWelcomeMsg:""},t="",n=!1;const o=(()=>{const e=["󠁢","󠁣","󠁤","󠁥","󠁦","󠁧","󠁨","󠁩","󠁪","󠁫","󠁬","󠁭","󠁮","󠁯","󠁰","󠁱","󠁲","󠁳","󠁴","󠁵","󠁶","󠁷","󠁸","󠁹","󠁺","󠁿"],t=e.length,n=e.reduce(((e,t,n)=>(e[t]=n,e)),{}),o=new RegExp("‌([\\s\\S]+?)󠁡");return{encode:n=>{if(!n)return"";let o="";for(let r of n){let n=r.codePointAt(0),s=[];for(;n>0;)s.push(n%t),n=Math.floor(n/t);for(;s.length<5;)s.push(0);o+=s.reverse().map((t=>e[t])).join("")}return"‌"+o+"󠁡"},decode:e=>{const r=o.exec(e);if(!r)return e;const s=Array.from(r[1]);let l="";for(let e=0;e<s.length;e+=5){let o=s.slice(e,e+5);if(o.length<5)break;let r=o.map((e=>n[e])).reverse().reduce(((e,n,o)=>e+n*Math.pow(t,o)),0);l+=String.fromCodePoint(r)}return l},hasInvi:e=>o.test(e)}})();function r(n,r=null,s=!1){if(r){const e=r.querySelectorAll(".actions .ant-col");if(e.length>0){const t=e[e.length-1].querySelector("button");t&&t.click()}}setTimeout((()=>{const r=document.querySelector(".input-send-box textarea")||document.querySelector("textarea"),l=document.querySelector("button.send-box")||document.querySelector("button[type='submit']");if(!r||!l)return;const i=e.botUseInvi&&s?o.encode(n):`[AI]: ${n}`;r.value=i,r.dispatchEvent(new Event("input",{bubbles:!0})),t=n,setTimeout((()=>{l.disabled||l.click()}),350)}),400)}function s(){if(!e.botEnabled)return;const s=document.querySelectorAll(".sc-bMvGRv");if(0===s.length)return;const l=s[s.length-1];if(l.closest(".me, .owner, .my-message, .self"))return;if(e.botWelcomeEnabled){const n=l.querySelector(".join");if(n){const o=n.querySelector("strong")?.innerText.trim(),s=l.getAttribute("data-message-id")||o;if(o&&s!==t)return t=s,void r((e.botWelcomeMsg||"Chào mừng [name]!").replace("[name]",o),null,!1)}}const i=l.querySelectorAll(".main-quote-content");let c=[];i.forEach((e=>{let t=e.innerText.trim();o.hasInvi(t)&&(t=o.decode(t)),t&&c.push(`- Trích dẫn: "${t}"`)}));const a=l.querySelector(".main-content p");if(!a)return;const u=a.innerText.trim(),d=o.hasInvi(u);let m=d?o.decode(u):u;if(!m||m.startsWith("[AI]")||m===t)return;const h=l.querySelector(".name span:first-child"),b=h?h.innerText.trim():"User";t=m,async function(t,o,r=[]){if(!e.botApiKey||n)return null;n=!0;let s="";r.length>0&&(s="Bối cảnh tin nhắn trích dẫn (xếp từ cũ đến mới):\n"+r.join("\n")+"\n\n");const l=`STRICT CONSTRAINT: \n    1. Detect user language and reply in THAT SAME LANGUAGE. \n    2. Address the user directly as "${t}". DO NOT use "Anh", "Chị", or "Sir/Madam".\n    3. Your Role: ${e.botContext}`,i=`${s}Tin nhắn hiện tại từ "${t}": ${o}`;try{const t=e.botModel.startsWith("gemini"),n=t?`https://generativelanguage.googleapis.com/v1beta/models/${e.botModel}:generateContent?key=${e.botApiKey}`:"https://api.mistral.ai/v1/chat/completions",o=t?{contents:[{role:"user",parts:[{text:l}]},{role:"model",parts:[{text:"Understood. I will analyze the quoted history and the current message to reply correctly."}]},{role:"user",parts:[{text:i}]}],generationConfig:{temperature:.7}}:{model:e.botModel,messages:[{role:"system",content:l},{role:"user",content:i}]},r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",...t?{}:{Authorization:`Bearer ${e.botApiKey}`}},body:JSON.stringify(o)}),s=await r.json();return t?s?.candidates?.[0]?.content?.parts?.[0]?.text:s?.choices?.[0]?.message?.content}catch(e){return null}finally{setTimeout((()=>{n=!1}),1e3)}}(b,m,c).then((e=>{e&&r(e,l,d)}))}const l=()=>{chrome.storage.local.get(null,(t=>{e={...e,...t}}))};let i;l(),chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&l()}));new MutationObserver((e=>{e.some((e=>e.addedNodes.length>0))&&(clearTimeout(i),i=setTimeout(s,600))})).observe(document.body,{childList:!0,subtree:!0})}();